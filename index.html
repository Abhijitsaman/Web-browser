<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Browser Home</title>
    <!-- A modern, clean font similar to the one used in Chrome for Android -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS Reset and Base Styles --- */
        :root {
            /* Light Theme (Default) */
            --background-color: #FFFFFF;
            --text-color: #202124;
            --secondary-text-color: #5f6368;
            --link-color: #1a0dab;
            --search-bar-bg: #f1f3f4;
            --shortcut-icon-bg: #f1f3f4;
            --modal-overlay-bg: rgba(0, 0, 0, 0.5);
            --dropdown-bg: #ffffff;
            --dropdown-text-color: #202124;
            --dropdown-hover-bg: #f1f3f4;
            --button-color: #1a73e8;
            --border-color: #dfe1e5;
            --shadow-color: rgba(0,0,0,0.08);
            --toast-bg: rgba(32, 33, 36, 0.9);
            --toast-text-color: #FFFFFF;
            --delete-icon-bg: rgba(255, 0, 0, 0.7);
        }

        /* Dark Theme class applied to <body> */
        body.dark-theme {
            --background-color: #202124;
            --text-color: #e8eaed;
            --secondary-text-color: #969ba1;
            --link-color: #8ab4f8;
            --search-bar-bg: #303134;
            --shortcut-icon-bg: #303134;
            --modal-overlay-bg: rgba(0, 0, 0, 0.7);
            --dropdown-bg: #3c4043;
            --dropdown-text-color: #e8eaed;
            --dropdown-hover-bg: rgba(255, 255, 255, 0.1);
            --border-color: #3c4043;
            --shadow-color: rgba(0,0,0,0.3);
            --toast-bg: rgba(232, 234, 237, 0.9);
            --toast-text-color: #202124;
            --delete-icon-bg: rgba(255, 80, 80, 0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            overscroll-behavior: none;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        
        .hidden {
            display: none !important;
        }

        /* --- Main App Header (Home Screen Only) --- */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background-color: var(--background-color);
        }

        .header-icons {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .icon-button {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            background: none;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
        }
        
        .icon-button svg {
            fill: var(--text-color);
        }

        .tab-switcher {
            font-size: 14px;
            font-weight: 500;
            border: 2px solid var(--secondary-text-color);
            border-radius: 6px;
            padding: 2px 8px;
            min-width: 28px;
            text-align: center;
        }

        /* --- Dropdown Menu --- */
        .dropdown-menu { display: none; position: fixed; top: 60px; right: 10px; background-color: var(--dropdown-bg); color: var(--dropdown-text-color); border-radius: 12px; box-shadow: 0 4px 10px var(--shadow-color); width: 280px; z-index: 1001; overflow: hidden; animation: fadeIn 0.15s ease-out; }
        .dropdown-menu.show { display: block; }
        .dropdown-menu ul { list-style: none; }
        .dropdown-menu ul li { display: flex; align-items: center; padding: 12px 16px; font-size: 16px; cursor: pointer; }
        .dropdown-menu ul li:hover { background-color: var(--dropdown-hover-bg); }
        .dropdown-menu ul li svg { margin-right: 16px; fill: var(--dropdown-text-color); }
        .dropdown-menu-divider { height: 1px; background-color: var(--border-color); margin: 8px 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Dark Mode Toggle Switch --- */
        .theme-switch-wrapper { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .theme-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--button-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- Main Home Screen Content --- */
        #home-screen { padding-bottom: 20px; }
        .search-container { padding: 16px; text-align: center; }
        .search-bar { width: 100%; padding: 14px 20px; font-size: 16px; border: none; border-radius: 28px; background-color: var(--search-bar-bg); color: var(--text-color); outline: none; }
        .search-bar::placeholder { color: var(--secondary-text-color); }

        /* --- Shortcut Area --- */
        .shortcuts-container { padding: 16px 8px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 16px; justify-items: center; }
        .shortcut-item { display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; text-decoration: none; width: 80px; }
        .shortcut-icon { width: 52px; height: 52px; border-radius: 50%; background-color: var(--shortcut-icon-bg); display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: 500; color: var(--text-color); background-size: cover; background-position: center; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative; }
        .shortcut-icon img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .shortcut-name { font-size: 12px; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }

        /* --- Modal for "Add Site" --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-overlay-bg); justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.show { display: flex; }
        .modal-content { background-color: var(--background-color); padding: 24px; border-radius: 16px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideIn 0.2s ease-out; }
        .modal-content h2 { margin-bottom: 20px; font-size: 20px; font-weight: 500; }
        .modal-form-group { margin-bottom: 16px; }
        .modal-input { width: 100%; padding: 12px; border: 1px solid var(--secondary-text-color); border-radius: 8px; background-color: transparent; color: var(--text-color); font-size: 16px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; }
        .modal-button { padding: 10px 20px; border: none; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; }
        .modal-button-cancel { background-color: transparent; color: var(--button-color); }
        .modal-button-add { background-color: var(--button-color); color: white; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Search Results Page Styles --- */
        #search-results-page { padding-top: 120px; }
        .fixed-results-header { position: fixed; top: 0; left: 0; width: 100%; padding: 12px 16px; background-color: var(--background-color); z-index: 1000; box-shadow: 0 2px 4px var(--shadow-color); }
        .results-header-tabs { position: fixed; top: 68px; left: 0; width: 100%; padding: 0 16px; border-bottom: 1px solid var(--border-color); background-color: var(--background-color); z-index: 999; }
        .filter-tabs-container { display: flex; gap: 20px; overflow-x: auto; -ms-overflow-style: none; scrollbar-width: none; }
        .filter-tabs-container::-webkit-scrollbar { display: none; }
        .filter-tab { padding: 12px 4px; font-size: 14px; font-weight: 500; color: var(--secondary-text-color); cursor: pointer; border-bottom: 3px solid transparent; white-space: nowrap; }
        .filter-tab.active { color: var(--button-color); border-bottom-color: var(--button-color); }
        .results-content-area { padding: 16px; }
        .loader { border: 4px solid var(--search-bar-bg); border-top: 4px solid var(--button-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Organic (All) Results */
        .organic-result-item { margin-bottom: 24px; }
        .organic-result-item a { text-decoration: none; }
        .organic-result-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .favicon { width: 20px; height: 20px; flex-shrink: 0; }
        .organic-result-link { font-size: 14px; color: var(--secondary-text-color); word-break: break-all; }
        .organic-result-title { font-size: 20px; color: var(--link-color); font-weight: 400; margin-bottom: 6px; }
        .organic-result-snippet { font-size: 14px; color: var(--secondary-text-color); line-height: 1.5; }

        /* --- IMPROVED: Image Results --- */
        .image-results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
        .image-result-item { display: flex; flex-direction: column; text-decoration: none; }
        .image-result-item .image-container { position: relative; width: 100%; padding-bottom: 100%; /* Square aspect ratio */ overflow: hidden; border-radius: 12px; margin-bottom: 8px; background-color: var(--shortcut-icon-bg);}
        .image-result-item img.main-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .image-title { font-size: 13px; color: var(--text-color); line-height: 1.4; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .image-source-info { display: flex; align-items: center; gap: 6px; text-decoration: none; }
        .image-source-info .favicon { width: 16px; height: 16px; }
        .image-source-name { font-size: 12px; color: var(--secondary-text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Video Results */
        .video-result-item { margin-bottom: 20px; }
        .video-result-item a { text-decoration: none; display: flex; gap: 12px; }
        .video-thumbnail-container { flex-shrink: 0; position: relative; }
        .video-thumbnail { width: 160px; height: 90px; border-radius: 8px; object-fit: cover; background-color: var(--search-bar-bg); display: block; }
        .video-duration { position: absolute; bottom: 6px; right: 6px; background-color: rgba(0,0,0,0.75); color: white; font-size: 12px; padding: 2px 6px; border-radius: 4px; }
        .video-info .video-title { font-size: 16px; color: var(--link-color); margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .video-info .video-source { font-size: 12px; color: var(--secondary-text-color); }

        /* Pagination */
        .pagination-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 32px; padding: 0 16px; }
        .pagination-button { padding: 10px 24px; border: 1px solid var(--border-color); border-radius: 20px; background-color: transparent; color: var(--button-color); font-size: 14px; font-weight: 500; cursor: pointer; }
        .pagination-button:disabled { color: var(--secondary-text-color); cursor: not-allowed; border-color: var(--search-bar-bg); }

        /* --- NEW: Exit Toast Message --- */
        .toast-message { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--toast-bg); color: var(--toast-text-color); padding: 12px 24px; border-radius: 24px; font-size: 14px; z-index: 3000; opacity: 0; transition: opacity 0.3s ease, bottom 0.3s ease; pointer-events: none; }
        .toast-message.show { opacity: 1; bottom: 40px; }

        /* --- NEW: Edit Shortcuts Page --- */
        #edit-shortcuts-page { padding-bottom: 20px; }
        .page-header { display: flex; align-items: center; padding: 16px; border-bottom: 1px solid var(--border-color); }
        .page-header h2 { font-size: 20px; font-weight: 500; margin-left: 16px; }
        .edit-shortcuts-list { padding: 8px 16px; }
        .edit-shortcut-item { display: flex; align-items: center; padding: 12px 0; }
        .edit-shortcut-item .shortcut-icon { margin: 0; } /* Reuse shortcut icon style */
        .edit-shortcut-info { flex-grow: 1; margin-left: 16px; }
        .edit-shortcut-name { font-size: 16px; color: var(--text-color); }
        .edit-shortcut-url { font-size: 13px; color: var(--secondary-text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .delete-shortcut-btn { cursor: pointer; width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 20px; color: white; background-color: var(--delete-icon-bg); border: none; flex-shrink: 0; }
    </style>
</head>
<body>
    <div id="app-container">
        <main id="home-screen">
            <header class="app-header">
                <button class="icon-button" id="home-button">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 5.69l5 4.5V18h-2v-6H9v6H7v-7.81l5-4.5M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z"/></svg>
                </button>
                <div class="header-icons">
                    <div class="tab-switcher" id="tab-count">1</div>
                    <button class="icon-button" id="menu-button">⋮</button>
                </div>
            </header>

            <div class="dropdown-menu" id="dropdown-menu">
                <ul>
                    <li><svg width="24" height="24" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>New Tab</li>
                    <li><svg width="24" height="24" viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>History</li>
                    <li><svg width="24" height="24" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/></svg>Downloads</li>
                    <div class="dropdown-menu-divider"></div>
                    <!-- NEW: Edit Shortcuts Option -->
                    <li id="edit-shortcuts-button"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>Edit Shortcuts</li>
                    <div class="dropdown-menu-divider"></div>
                    <li>
                        <div class="theme-switch-wrapper">
                            <span>Dark Mode</span>
                            <label class="theme-switch">
                                <input type="checkbox" id="theme-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </li>
                </ul>
            </div>
            
            <div class="search-container">
                <input type="search" id="search-bar" class="search-bar" placeholder="Search or type web address" autocomplete="off">
            </div>
            <div class="shortcuts-container" id="shortcuts-container">
                <div class="shortcut-item" id="add-shortcut-button">
                    <div class="shortcut-icon">+</div>
                    <p class="shortcut-name">Add Site</p>
                </div>
            </div>
        </main>
        
        <div id="search-results-page" class="hidden"></div>

        <!-- NEW: Edit Shortcuts Page -->
        <main id="edit-shortcuts-page" class="hidden">
             <header class="page-header">
                <button class="icon-button" id="edit-shortcuts-done-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <h2>Edit Shortcuts</h2>
            </header>
            <div class="edit-shortcuts-list" id="edit-shortcuts-list">
                <!-- Shortcuts will be dynamically inserted here -->
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="add-site-modal">
        <div class="modal-content">
            <h2>Add shortcut</h2>
            <form id="add-site-form">
                <div class="modal-form-group"><input type="text" id="site-name-input" class="modal-input" placeholder="Name" required></div>
                <div class="modal-form-group"><input type="url" id="site-url-input" class="modal-input" placeholder="URL" required></div>
                <div class="modal-actions">
                    <button type="button" class="modal-button modal-button-cancel" id="cancel-modal-button">Cancel</button>
                    <button type="submit" class="modal-button modal-button-add">Done</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- NEW: Toast message element -->
    <div class="toast-message" id="toast-message"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTS & CONFIGURATION ---
            const SHORTCUTS_STORAGE_KEY = 'browserHomePageShortcuts';
            const THEME_STORAGE_KEY = 'browserThemePreference';
            const SERP_API_KEY = '62ca9ec8ea4418341770d9b364c296924425415c29ff02427197f01a4a698284';
            const CORS_PROXY_URL = 'https://api.allorigins.win/raw?url=';
            
            // --- GLOBAL STATE ---
            let currentQuery = '';
            let currentPage = 1;
            let currentSearchType = 'all';
            let backPressOnHome = false;

            // --- DOM ELEMENT SELECTIONS ---
            const body = document.body;
            const homeButton = document.getElementById('home-button');
            const menuButton = document.getElementById('menu-button');
            const dropdownMenu = document.getElementById('dropdown-menu');
            const themeToggle = document.getElementById('theme-toggle');
            const searchBar = document.getElementById('search-bar');
            // Page containers
            const homeScreen = document.getElementById('home-screen');
            const searchResultsPage = document.getElementById('search-results-page');
            const editShortcutsPage = document.getElementById('edit-shortcuts-page');
            // Modal and Shortcut elements
            const addShortcutButton = document.getElementById('add-shortcut-button');
            const modalOverlay = document.getElementById('add-site-modal');
            const cancelModalButton = document.getElementById('cancel-modal-button');
            const addSiteForm = document.getElementById('add-site-form');
            const shortcutsContainer = document.getElementById('shortcuts-container');
            const siteNameInput = document.getElementById('site-name-input');
            const siteUrlInput = document.getElementById('site-url-input');
            // Edit Shortcuts elements
            const editShortcutsButton = document.getElementById('edit-shortcuts-button');
            const editShortcutsDoneBtn = document.getElementById('edit-shortcuts-done-btn');
            const editShortcutsList = document.getElementById('edit-shortcuts-list');
            // Toast
            const toastMessage = document.getElementById('toast-message');

            // --- THEME MANAGEMENT ---
            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    body.classList.add('dark-theme');
                    themeToggle.checked = true;
                } else {
                    body.classList.remove('dark-theme');
                    themeToggle.checked = false;
                }
            };
            const toggleTheme = () => {
                const newTheme = themeToggle.checked ? 'dark' : 'light';
                localStorage.setItem(THEME_STORAGE_KEY, newTheme);
                applyTheme(newTheme);
            };
            const initializeTheme = () => {
                const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
                if (savedTheme) {
                    applyTheme(savedTheme);
                } else {
                    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                    applyTheme(prefersDark ? 'dark' : 'light');
                }
            };
            themeToggle.addEventListener('change', toggleTheme);
            
            // --- UI/PAGE NAVIGATION LOGIC ---
            const showPage = (pageToShow) => {
                [homeScreen, searchResultsPage, editShortcutsPage].forEach(page => {
                    if (page === pageToShow) {
                        page.classList.remove('hidden');
                    } else {
                        page.classList.add('hidden');
                    }
                });
                document.documentElement.scrollTop = 0;
                backPressOnHome = false; // Reset exit confirmation on any navigation
            };

            // --- NEW: ROBUST HISTORY & BACK BUTTON MANAGEMENT ---
            const showToast = (message) => {
                toastMessage.textContent = message;
                toastMessage.classList.add('show');
                setTimeout(() => {
                    toastMessage.classList.remove('show');
                }, 2000);
            };

            window.addEventListener('popstate', (event) => {
                const state = event.state;
                if (!state || state.page === 'home') {
                    showPage(homeScreen);
                    if (backPressOnHome) {
                        // This allows the default behavior, which might be closing the PWA
                        // For a true app-like experience, a native wrapper would handle this better.
                        window.close(); 
                    } else {
                        backPressOnHome = true;
                        showToast("Press back again to exit");
                        setTimeout(() => { backPressOnHome = false; }, 2500);
                        // Push the state back so the next back press is caught again
                        history.pushState({ page: 'home' }, 'Home');
                    }
                } else if (state.page === 'results') {
                    performSearch(state.query, state.type, state.page, true);
                } else if (state.page === 'edit') {
                    showPage(editShortcutsPage);
                    renderEditShortcutsList();
                }
            });

            // Set initial state on load
            history.replaceState({ page: 'home' }, 'Home');

            homeButton.addEventListener('click', () => {
                // If on results page, go back. If already on home, do nothing.
                if (!homeScreen.classList.contains('hidden')) return;
                history.back();
            });

            // --- CORE SEARCH FUNCTIONALITY ---
            async function performSearch(query, type = 'all', page = 1, isHistoryNavigation = false) {
                currentQuery = query;
                currentSearchType = type;
                currentPage = page;

                if (!isHistoryNavigation) {
                    history.pushState({ page: 'results', query, type, page }, `Search for ${query}`);
                }
                showPage(searchResultsPage);
                renderResultsPageStructure(query);

                const apiUrl = buildApiUrl(query, type, page);
                const requestUrl = `${CORS_PROXY_URL}${encodeURIComponent(apiUrl)}`;
                
                try {
                    const response = await fetch(requestUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);
                    renderContent(data);
                } catch (error) {
                    console.error("Failed to fetch search results:", error);
                    const contentArea = document.getElementById('results-content-area');
                    if (contentArea) contentArea.innerHTML = `<p style="text-align:center; padding: 20px;">Failed to load results. ${error.message}</p>`;
                }
            }

            function buildApiUrl(query, type, page) {
                const encodedQuery = encodeURIComponent(query);
                const start = (page - 1) * 10; // Standard pagination is 10
                let url = `https://serpapi.com/search.json?q=${encodedQuery}&api_key=${SERP_API_KEY}&start=${start}`;
                if (type === 'images') url += '&tbm=isch';
                if (type === 'videos') url += '&tbm=vid';
                return url;
            }
            
            searchBar.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    const query = searchBar.value.trim();
                    if (query) performSearch(query, 'all', 1);
                }
            });

            // --- DYNAMIC RENDERING FOR RESULTS PAGE ---
            function renderResultsPageStructure(query) {
                searchResultsPage.innerHTML = `
                    <div class="fixed-results-header">
                        <input type="search" id="results-search-bar" class="search-bar" value="${escapeHTML(query)}">
                    </div>
                    <div class="results-header-tabs">
                        <div class="filter-tabs-container">
                            <div class="filter-tab ${currentSearchType === 'all' ? 'active' : ''}" data-type="all">All</div>
                            <div class="filter-tab ${currentSearchType === 'images' ? 'active' : ''}" data-type="images">Images</div>
                            <div class="filter-tab ${currentSearchType === 'videos' ? 'active' : ''}" data-type="videos">Videos</div>
                        </div>
                    </div>
                    <div class="results-content-area" id="results-content-area">
                        <div class="loader"></div>
                    </div>
                `;
                document.getElementById('results-search-bar').addEventListener('keydown', handleResultsSearch);
                document.querySelectorAll('.filter-tab').forEach(tab => tab.addEventListener('click', handleTabClick));
            }

            function renderContent(data) {
                const container = document.getElementById('results-content-area');
                if (!container) return;
                container.className = 'results-content-area';
                switch(currentSearchType) {
                    case 'images': renderImageResults(data.images_results, container); break;
                    case 'videos': renderVideoResults(data.video_results, container); break;
                    default: renderOrganicResults(data.organic_results, container); break;
                }
                renderPagination(data, container);
            }

            function renderOrganicResults(results, container) {
                if (!results || results.length === 0) { container.innerHTML = '<p>No web results found.</p>'; return; }
                const html = results.map(item => {
                    let domain = '';
                    try { domain = new URL(item.link).hostname; } catch (e) { domain = item.displayed_link.split(' ')[0]; }
                    return `
                    <div class="organic-result-item">
                        <a href="${item.link}" target="_blank">
                            <div class="organic-result-header">
                                <img class="favicon" src="https://www.google.com/s2/favicons?sz=32&domain=${domain}" alt="" loading="lazy" onerror="this.style.display='none'">
                                <span class="organic-result-link">${item.displayed_link}</span>
                            </div>
                            <h3 class="organic-result-title">${item.title}</h3>
                        </a>
                        <p class="organic-result-snippet">${item.snippet || ''}</p>
                    </div>`;
                }).join('');
                container.innerHTML = html;
            }

            function renderImageResults(results, container) {
                if (!results || results.length === 0) { container.innerHTML = '<p>No image results found.</p>'; return; }
                container.classList.add('image-results-grid');
                const html = results.map(item => {
                    let domain = '';
                    try { domain = new URL(item.link).hostname; } catch (e) {}
                    return `
                    <div class="image-result-item">
                        <a href="${item.original}" target="_blank" class="image-container">
                            <img src="${item.thumbnail}" alt="${escapeHTML(item.title)}" class="main-image" loading="lazy">
                        </a>
                        <div class="image-title">${escapeHTML(item.title)}</div>
                        <a href="${item.link}" target="_blank" class="image-source-info">
                            <img src="https://www.google.com/s2/favicons?sz=16&domain=${domain}" class="favicon" alt="" loading="lazy" onerror="this.style.display='none'">
                            <span class="image-source-name">${item.source}</span>
                        </a>
                    </div>`;
                }).join('');
                container.innerHTML = html;
            }
            
            function renderVideoResults(results, container) {
                if (!results || results.length === 0) { container.innerHTML = '<p>No video results found.</p>'; return; }
                const html = results.map(item => `
                    <div class="video-result-item">
                       <a href="${item.link}" target="_blank">
                           <div class="video-thumbnail-container">
                               <img src="${item.thumbnail}" class="video-thumbnail" loading="lazy">
                               ${item.duration ? `<span class="video-duration">${item.duration}</span>` : ''}
                           </div>
                           <div class="video-info">
                               <div class="video-title">${item.title}</div>
                               <div class="video-source">${item.source} &middot; ${item.published_date || ''}</div>
                           </div>
                       </a>
                    </div>`).join('');
                container.innerHTML = html;
            }

            function renderPagination(data, container) {
                const paginationData = data.serpapi_pagination;
                if (!paginationData) return;
                const hasPrev = currentPage > 1;
                const hasNext = paginationData.next;
                const paginationHTML = `
                    <div class="pagination-controls">
                        <button id="prev-page-btn" class="pagination-button" ${!hasPrev ? 'disabled' : ''}>Previous</button>
                        <span>Page ${currentPage}</span>
                        <button id="next-page-btn" class="pagination-button" ${!hasNext ? 'disabled' : ''}>Next</button>
                    </div>`;
                container.insertAdjacentHTML('beforeend', paginationHTML);
                if (hasPrev) document.getElementById('prev-page-btn').addEventListener('click', () => performSearch(currentQuery, currentSearchType, currentPage - 1));
                if (hasNext) document.getElementById('next-page-btn').addEventListener('click', () => performSearch(currentQuery, currentSearchType, currentPage + 1));
            }
            
            // --- EVENT HANDLERS FOR DYNAMIC ELEMENTS ---
            function handleResultsSearch(event) {
                if (event.key === 'Enter') {
                    const query = event.target.value.trim();
                    if (query && query !== currentQuery) performSearch(query, 'all', 1);
                }
            }

            function handleTabClick(event) {
                const type = event.currentTarget.dataset.type;
                if (type !== currentSearchType) {
                    // Instantly show loader for better UX
                    const container = document.getElementById('results-content-area');
                    if (container) container.innerHTML = '<div class="loader"></div>';
                    performSearch(currentQuery, type, 1);
                }
            }

            // --- UTILITY FUNCTIONS ---
            function escapeHTML(str) {
                return str.replace(/[&<>"']/g, match => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'})[match]);
            }
            
            // --- MENU, MODAL, SHORTCUTS LOGIC ---
            const toggleMenu = () => dropdownMenu.classList.toggle('show');
            menuButton.addEventListener('click', e => { e.stopPropagation(); toggleMenu(); });
            window.addEventListener('click', e => { if (dropdownMenu.classList.contains('show') && !dropdownMenu.contains(e.target) && e.target !== menuButton) { toggleMenu(); }});
            const showModal = () => modalOverlay.classList.add('show');
            const hideModal = () => { modalOverlay.classList.remove('show'); addSiteForm.reset(); };
            addShortcutButton.addEventListener('click', showModal);
            cancelModalButton.addEventListener('click', hideModal);
            modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) hideModal(); });
            const getShortcuts = () => JSON.parse(localStorage.getItem(SHORTCUTS_STORAGE_KEY)) || [];
            const saveShortcuts = shortcuts => localStorage.setItem(SHORTCUTS_STORAGE_KEY, JSON.stringify(shortcuts));
            
            const renderShortcuts = () => {
                const existingShortcuts = shortcutsContainer.querySelectorAll('.shortcut-item:not(#add-shortcut-button)');
                existingShortcuts.forEach(sc => sc.remove());
                getShortcuts().forEach(shortcut => {
                    const shortcutElement = createShortcutElement(shortcut.name, shortcut.url);
                    shortcutsContainer.insertBefore(shortcutElement, addShortcutButton);
                });
            };
            const createShortcutElement = (name, url) => {
                const shortcutLink = document.createElement('a');
                shortcutLink.href = url;
                shortcutLink.className = 'shortcut-item';
                shortcutLink.title = name;
                const iconDiv = document.createElement('div');
                iconDiv.className = 'shortcut-icon';
                const nameP = document.createElement('p');
                nameP.className = 'shortcut-name';
                nameP.textContent = name;
                try {
                    const hostname = new URL(url).hostname;
                    const faviconUrl = `https://www.google.com/s2/favicons?sz=64&domain=${hostname}`;
                    const img = new Image();
                    img.src = faviconUrl;
                    img.onload = () => { iconDiv.innerHTML = ''; iconDiv.appendChild(img); };
                    img.onerror = () => { iconDiv.textContent = name.charAt(0).toUpperCase(); };
                } catch (error) {
                    console.error("Error creating favicon URL:", error);
                    iconDiv.textContent = name.charAt(0).toUpperCase();
                }
                shortcutLink.appendChild(iconDiv);
                shortcutLink.appendChild(nameP);
                return shortcutLink;
            };
            addSiteForm.addEventListener('submit', e => {
                e.preventDefault();
                const name = siteNameInput.value.trim();
                let url = siteUrlInput.value.trim();
                if (name && url) {
                    if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
                    const shortcuts = getShortcuts();
                    shortcuts.push({ name, url });
                    saveShortcuts(shortcuts);
                    renderShortcuts();
                    hideModal();
                }
            });

            // --- NEW: EDIT SHORTCUTS FUNCTIONALITY ---
            const renderEditShortcutsList = () => {
                editShortcutsList.innerHTML = '';
                const shortcuts = getShortcuts();
                if (shortcuts.length === 0) {
                    editShortcutsList.innerHTML = '<p style="text-align:center; padding: 20px; color: var(--secondary-text-color);">No shortcuts added yet.</p>';
                    return;
                }
                shortcuts.forEach((shortcut, index) => {
                    const item = document.createElement('div');
                    item.className = 'edit-shortcut-item';
                    const icon = createShortcutElement(shortcut.name, shortcut.url).querySelector('.shortcut-icon');
                    item.innerHTML = `
                        <div class="edit-shortcut-info">
                            <div class="edit-shortcut-name">${escapeHTML(shortcut.name)}</div>
                            <div class="edit-shortcut-url">${escapeHTML(shortcut.url)}</div>
                        </div>
                        <button class="delete-shortcut-btn" data-index="${index}" title="Delete Shortcut">&times;</button>
                    `;
                    item.prepend(icon);
                    editShortcutsList.appendChild(item);
                });
            };

            editShortcutsButton.addEventListener('click', () => {
                history.pushState({ page: 'edit' }, 'Edit Shortcuts');
                showPage(editShortcutsPage);
                renderEditShortcutsList();
                dropdownMenu.classList.remove('show');
            });

            editShortcutsDoneBtn.addEventListener('click', () => {
                history.back();
            });

            editShortcutsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-shortcut-btn')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    let shortcuts = getShortcuts();
                    shortcuts.splice(index, 1);
                    saveShortcuts(shortcuts);
                    renderShortcuts(); // Update home screen
                    renderEditShortcutsList(); // Update current screen
                }
            });

            // --- INITIAL LOAD ---
            initializeTheme();
            renderShortcuts();
        });
    </script>
</body>
</html>
